@page "/lobby/{lobbyId}"
@using Microsoft.AspNetCore.SignalR.Client
@inject LocalStorage LocalStorage
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject UserState UserState
@inject LobbyConnection LobbyConnection

@LobbyId

@if (LobbyConnection.Lobby != null)
{
    <span>
        Invite: @LobbyConnection.Lobby.InviteLink
    </span>
    @if (LobbyConnection.Lobby.Players != null)
    {
        foreach (var player in LobbyConnection.Lobby.Players)
        {
            <div>
                @player.Name
            </div>
        }
    }
}



<div>
    Name: @_user.Name
</div>
<div>
    Id: @_user.Id
</div>

@if (!string.IsNullOrEmpty(_info))
{
    <div class="alert alert-danger">@_info</div>
}

@if (LobbyConnection.Messages != null)
{
    <ChatComponent Messages="@LobbyConnection.Messages"></ChatComponent>
}

<button @onclick="Reload">reload</button>


@code {
    [Parameter]
    public string LobbyId { get; set; }

    private UserDto _user = new UserDto();
    private string _info = string.Empty;
    //private LobbyDto _lobby;
    //private List<Message> _messages = new List<Message>();

    //private HubConnection _hubConnection;

    protected async override Task OnInitializedAsync()
    {
        try
        {
            _user = await UserState.GetUser();
        }
        catch (UserNotInLocalStorageException exception)
        {
            _info = exception.Message;
        }

        //TODO: Separate to other classes
        //Retrieve initial Lobby state
        //string query = String.Format("lobbies/{0}/{1}", LobbyId, _user.Id);
        ////Console.WriteLine(query);
        //_lobby = await Http.GetJsonAsync<LobbyDto>(query);

        //Connect to SignalRHub
        //TODO: Create Singleton
        //_hubConnection = new HubConnectionBuilder().WithUrl(NavigationManager.ToAbsoluteUri("/lobbyHub"), options =>
        //{
        //    options.Headers.Add("User", _user.Id);
        //    options.Headers.Add("Lobby", LobbyId);
        //}
        //    ).Build();
        LobbyConnection.StateChanged += Update;
        await LobbyConnection.StartConnection(_user, NavigationManager.ToAbsoluteUri("/lobbyHub"), LobbyId);
        await base.OnInitializedAsync();
    }

    private void Update(object sender, EventArgs e)
    {
        StateHasChanged();
    }

    public void Reload()
    {
        StateHasChanged();
    }

    //public bool IsConnected =>
    //    _hubConnection.State == HubConnectionState.Connected;


}
